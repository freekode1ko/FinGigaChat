user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    client_max_body_size ${NGINX_MAX_BODY_SIZE};

    upstream article {
        server article_container:${PORT_ARTICLE};
    }

    upstream article_online {
        server article_online_container:${PORT_ARTICLE_ONLINE};
    }

    upstream bot {
        server bot_container:${PORT_BOT};
    }

    upstream bert_client_relevance {
        server bert_client_relevance_container:${PORT_BERT_CLIENT_RELEVANCE};
    }

    upstream bert_commodity_relevance {
        server bert_commodity_relevance_container:${PORT_BERT_COMMODITY_RELEVANCE};
    }

    upstream web_app {
        server web_app_container:${PORT_WEB_APP};
    }

    upstream web_retriever {
        server web_retriever_container:${PORT_WEB_RETRIEVER};
    }

    upstream quotes {
        server quotes_container:${PORT_QUOTES};
    }

    upstream research {
        server research_container:${PORT_RESEARCH};
    }

    upstream users_statistics {
        server users_statistics_container:${PORT_USERS_STATISTICS};
    }

    server {
        listen 80;
        server_name ${DOMAIN_NAME};

        location / {
            return 301 https://$host$request_uri;
        }
    }

    server {
        listen 443 ssl;
        server_name ${DOMAIN_NAME};

        ssl_certificate /certs/fullchain.pem;
        ssl_certificate_key /certs/privkey.pem;

        location /service/article/ {
            proxy_pass http://article/;
        }

        location /service/article_online/ {
            proxy_pass http://article_online/;
        }

        location /service/bot/ {
            proxy_pass http://bot/;
        }

        location /service/research/ {
            proxy_pass http://research/;
        }

        location /service/web_app/ {
            proxy_pass http://web_app/;
        }

        location /service/web_retriever/ {
            proxy_pass http://web_retriever/;
        }

        location /service/users_statistics/ {
            proxy_pass http://users_statistics/;
        }

        location /service/bert_relevance/ {
            proxy_pass http://bert_client_relevance/;
        }

        location /service/quotes/ {
            proxy_pass http://quotes/;
        }

        location / {
            proxy_pass http://web_app/;  # FIXME: это фикс для статики
        }
    }
}
